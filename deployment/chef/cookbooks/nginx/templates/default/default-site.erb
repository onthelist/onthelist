server {
  listen *:80;
  server_name  <%= node[:hostname] %>;
  access_log  <%= node[:nginx][:log_dir] %>/localhost.access.log;

  root /home/www-server/onthelist/site/public;
  index index.html;

  server_name localhost;

  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  
  location = / {
    proxy_pass http://cf.speedyseat.us/<%=`/bin/bash -c "GIT_DIR=/home/www-server/onthelist/.git git rev-parse HEAD"`.strip%>.html;

    proxy_cache index;
    proxy_cache_key "$request_uri";
    
    proxy_cache_valid 200 302 301 1h;
    proxy_cache_valid any 5s;
  
    allow all;
  }

  location / {
    allow all;
  }

  location /extern/ {
    alias /home/www-server/onthelist/site/extern/;
  }

  location /init/ {
    alias /home/www-server/init/;
  }

<% node[:nginx][:apps].each do |app, port| %>
  location /<%= app %>/ {
    access_log /home/www-server/logs/access_<%= app %>.log app;

    proxy_add_header X-App-Served-By $proxy_host;
    proxy_add_header X-Served-By $hostname;

    proxy_pass http://app_<%= app %>;
  }
<% end %>
}


##
# Virtual Host Configs
##

include /etc/nginx/conf.d/*.conf;
#include /etc/nginx/sites-enabled/*;
